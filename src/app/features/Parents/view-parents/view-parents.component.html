<div class="h-full flex flex-col">

  <div>
    <div class="flex gap-[40px] items-baseline ml-5 mt-3">
      <h1>Opiekunowie / rodzice</h1>

      <div class="flex items-baseline gap-[5px]">
        <button [matMenuTriggerFor]="menu" [disabled]="!selection.selected.length" mat-stroked-button color="primary">
          <mat-icon>
            arrow_drop_down
          </mat-icon>
          Akcje
        </button>

        <div>
          <mat-form-field class="w-[250px]" appearance="outline">
            <mat-select
              [(ngModel)]="selectSort"
              (selectionChange)="selectSortOnChange()"
              [disabled]="isProgress"
            >
              <mat-option
                *ngFor="let sort of sortParents;"
                [value]="sort.value"
              >
                {{ sort.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

    </div>

    <mat-menu #menu="matMenu">
      <button mat-menu-item (click)="getMassiveActions('deleted')" [disabled]="!selection.selected.length">
        <mat-icon color="primary">delete</mat-icon>
        <span>
        {{ selection.selected.length == 1 ? 'Usuń opiekuna' : 'Usuń opiekunów' }}
      </span>
      </button>

      <hr>

      <button mat-menu-item (click)="getMassiveActions('blocked')" [disabled]="!selection.selected.length">
        <mat-icon color="primary">block</mat-icon>
        <span>
          Zablokuj dostęp do konta
        </span>
      </button>
      <button mat-menu-item (click)="getMassiveActions('unblocked')" [disabled]="!selection.selected.length">
        <mat-icon color="primary">published_with_changes</mat-icon>
        <span>
          Odblokuj dostęp do konta
        </span>
      </button>

    </mat-menu>
  </div>

  <ng-container>
    <mat-card class="m-2 p-0 flex-1 flex flex-col overflow-hidden">
      <app-loading-html *ngIf="isProgress"></app-loading-html>

      <div class="flex-1 overflow-auto" style="border-bottom: 1px solid #ccc; padding-bottom: 8px;">
        <table mat-table matSort (matSortChange)="sortData($event)" [dataSource]="dataSource"
               class="w-full text-sm border-collapse">

          <ng-container matColumnDef="select">
            <th mat-header-cell class="w-[2%] text-center" *matHeaderCellDef>
              <mat-checkbox
                (change)="masterToggle()"
                [checked]="isAllSelected()"
                [indeterminate]="selection.hasValue() && !isAllSelected()"
                [matTooltip]="checkboxLabel()"
                color="primary"
              >
              </mat-checkbox>
            </th>

            <td mat-cell *matCellDef="let element">
              <mat-checkbox
                (click)="$event.stopPropagation()"
                (change)="$event ? selection.toggle(element.id) : null"
                [checked]="selection.isSelected(element.id)"
                [matTooltip]="checkboxLabel(element.id)"
                color="primary"
              >
              </mat-checkbox>
            </td>
          </ng-container>

          <ng-container matColumnDef="full_user_name">
            <th mat-header-cell class="px-4 py-2 border-b text-center" *matHeaderCellDef mat-sort-header>
              Opiekun / rodzic
            </th>
            <td mat-cell *matCellDef="let element"> {{ element.full_user_name || '-' }}</td>
          </ng-container>

          <ng-container matColumnDef="email">
            <th mat-header-cell class="px-4 py-2 border-b text-center" *matHeaderCellDef mat-sort-header> E-mail</th>
            <td mat-cell class="px-4 py-2 border-b text-center" *matCellDef="let element"> {{ element.email || '-' }}</td>
          </ng-container>

          <ng-container matColumnDef="student">
            <th mat-header-cell class="px-4 py-2 border-b text-center" *matHeaderCellDef mat-sort-header> Uczeń
            </th>
            <td mat-cell class="px-4 py-2 border-b text-center"
                *matCellDef="let element"> {{ element?.student?.full_user_name || '-' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="class">
            <th mat-header-cell class="px-4 py-2 border-b text-center" *matHeaderCellDef mat-sort-header> Oddział
            </th>
            <td mat-cell class="px-4 py-2 border-b text-center"
                *matCellDef="let element"> {{ element?.student?.class?.class || '-' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="year">
            <th mat-header-cell class="px-4 py-2 border-b text-center" *matHeaderCellDef mat-sort-header> Rok szkolny
            </th>
            <td mat-cell class="px-4 py-2 border-b text-center"
                *matCellDef="let element"> {{ element?.student?.class?.year || '-' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell class="border-b text-center" *matHeaderCellDef>Akcja</th>
            <td mat-cell class="w-[1%]" *matCellDef="let element">
              <button color="primary" matTooltip="Edytuj" mat-icon-button (click)="goToStudent(element.id)">
                <mat-icon>edit</mat-icon>
              </button>
            </td>
          </ng-container>

          <ng-container matColumnDef="gender">
            <th mat-header-cell class="border-b text-center" *matHeaderCellDef>Płeć</th>
            <td mat-cell class="w-[1%]" *matCellDef="let element">
              {{ element.gender || '-' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="is_active">
            <th mat-header-cell class="border-b text-center" *matHeaderCellDef mat-sort-header>
              Zablokowany dostęp
            </th>
            <td mat-cell class="px-4 py-2 border-b text-center" *matCellDef="let element">
            <span class="px-2 py-1 rounded-full text-white text-sm"
                  [ngClass]="element.is_active ? 'bg-green-800' : 'bg-red-800'">
                        {{ !element.is_active ? 'Tak' : 'Nie' }}
                      </span>
            </td>
          </ng-container>

          <tr mat-header-row class="bg-gray-100 text-center sticky-header" *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row class="hover:bg-gray-100" *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>

        <ng-container *ngIf="parents_list.length == 0 || !parents_list">
          <div class="text-center p-4 text-gray-500">
            Brak powiązanych rodziców / opiekunów. <br>
            W celu dodania rodziców / opiekunów do ucznia, należy przejść do ucznia i dodać ich w sekcji "Rodzice / Opiekunowie".
          </div>
        </ng-container>

      </div>
      <mat-paginator
        [length]="totalItems"
        [pageSize]="pageSize"
        [pageIndex]="currentPage - 1"
        [pageSizeOptions]="[5, 10, 15, 20, 25, 30, 35, 50, 100]"
        (page)="onPageChange($event)">
      </mat-paginator>
    </mat-card>
  </ng-container>

</div>
